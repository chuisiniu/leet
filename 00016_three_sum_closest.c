/*
 * 给你一个长度为 n 的整数数组 nums 和 一个目标值 target。请你从 nums
 *   中选出三个整数，使它们的和与 target 最接近。
 *
 *   返回这三个数的和。
 *
 *   假定每组输入只存在恰好一个解。
 * 示例 1：
 *
 *  输入：nums = [-1,2,1,-4], target = 1
 *  输出：2
 *  解释：与 target 最接近的和是 2 (-1 + 2 + 1 = 2) 。
 *
 * 示例 2：
 *
 *  输入：nums = [0,0,0], target = 1
 *  输出：0
 *
 *
 * 提示：
 *
 *  3 <= nums.length <= 1000
 *  -1000 <= nums[i] <= 1000
 *  -104 <= target <= 104
 */

#include "stdio.h"
#include "stdlib.h"
#include "string.h"

#define distance(_a, _b) ((_a) < (_b) ? (_b) - (_a) : (_a) - (_b))

int cmp(const void *d1, const void *d2) { return *((int *)d1) - *((int *)d2); }

int binarySearch(int *nums, int numsSize, int value)
{
	int start;
	int end;
	int mid;
	int d1;
	int d2;

	start = 0;
	end = numsSize - 1;

	while (start < end) {
		mid = (start + end) / 2;
		if (nums[mid] == value)
			return value;
		else if (nums[mid] < value) {
			if (mid + 1 <= numsSize && value < nums[mid + 1]) {
				d1 = distance(nums[mid], value);
				d2 = distance(nums[mid + 1], value);

				return d1 < d2 ? nums[mid] : nums[mid + 1];
			}
			start = mid + 1;
		} else if (nums[mid] > value) {
			if (mid > 0 && value > nums[mid - 1]) {
				d1 = distance(nums[mid], value);
				d2 = distance(nums[mid - 1], value);
				return d1 < d2 ? nums[mid] : nums[mid - 1];
			}
			end = mid - 1;
		}
	}

	if (0 <= start && start < numsSize )
		return nums[start];

	return nums[end];
}

int threeSumClosest1(int *nums, int numsSize, int target)
{
    int range_start;
    int range_end;
    int sum;
    int step;
    int i;
    int j;
    int n;
    int sum2;
    int distance;
    int distance_min;
    int result;
        int tmp;

    if (numsSize == 3)
		return nums[0] + nums[1] + nums[2];

    qsort(nums, numsSize, sizeof(int), cmp);

    if (target > 0) {
		range_start = 0;
		range_end = 2 * target;
    } else {
		range_start = 2 * target;
		range_end = 0;
    }

    sum  = nums[numsSize - 3] + nums[numsSize - 2] + nums[numsSize - 1];
    if (sum <= range_start)
		return sum;

    sum  = nums[0] + nums[1] + nums[2];
    if (sum >= range_end)
		return sum;

    distance_min = distance(sum, target);
	result = sum;
    for (i = 0; i < numsSize - 2; i++) {
		sum = nums[i] + nums[numsSize - 1] + nums[numsSize - 2];
		if (sum < range_start)
			continue;
		sum = nums[i] + nums[i + 1] + nums[i + 2];
		if (sum > range_end)
			continue;
        for (j = i + 1; j < numsSize - 1; j++) {
            sum2 = nums[i] + nums[j];
            if (sum2 + nums[numsSize - 1] < range_start)
				continue;

            n = target - sum2;
			tmp = binarySearch(nums + j + 2, numsSize - j - 2, n);
			sum = tmp + sum2;
			distance = distance(sum, target);
			if (distance < distance_min) {
				result = sum;
				distance_min = distance;
				if (0 == distance_min)
					return result;
				range_start = target - distance_min;
				range_end = target + distance_min;
			}
			while (j + 1 < numsSize - 1 && nums[j + 1] == nums[j])
				j++;
        }
		while (i + 1 < numsSize - 2 && nums[i + 1] == nums[i])
			i++;
    }

    return result;
}

int threeSumClosest(int *nums, int numsSize, int target)
{
	int i;
	int j;
	int k;
	int tmp;
	int sum;
	int min_distance;
	int distance;
	int result;
    int range_start;
    int range_end;

    if (numsSize == 3)
		return nums[0] + nums[1] + nums[2];

    qsort(nums, numsSize, sizeof(int), cmp);
    if (target > 0) {
		range_start = 0;
		range_end = 2 * target;
    } else {
		range_start = 2 * target;
		range_end = 0;
    }

    sum  = nums[numsSize - 3] + nums[numsSize - 2] + nums[numsSize - 1];
    if (sum <= range_start)
		return sum;

    sum  = nums[0] + nums[1] + nums[2];
    if (sum >= range_end)
		return sum;

	result = sum;
	min_distance = 300000;
	for (i = 0; i < numsSize - 2; i++) {
		while (i > 0 && i < numsSize && nums[i] == nums[i - 1])
			i++;
		if (i >= numsSize - 2)
			break;

		sum = nums[i] + nums[numsSize - 1] + nums[numsSize - 2];
		if (sum < range_start)
			continue;
		sum = nums[i] + nums[i + 1] + nums[i + 2];
		if (sum > range_end)
			continue;

		j = i + 1;
		k = numsSize - 1;
		while (j < k) {
			sum = nums[i] + nums[j] + nums[k];
			if (sum == target)
				return sum;
			distance = distance(sum, target);
			if (distance < min_distance) {
				min_distance = distance;
				result = sum;
				range_start = target - min_distance;
				range_end = target + min_distance;
			}

			if (sum > target) {
				tmp = k;
				while (j < k && nums[k] == nums[tmp])
					k--;
			} else {
				tmp = j;
				while (j < k && nums[j] == nums[tmp])
					j++;
			}
		}
	}

	return result;
}

int main(char argc, char **argv)
{
#ifndef ARRAY_SIZE
#define ARRAY_SIZE(_arr) (sizeof(_arr) / sizeof(_arr[0]))
#endif
	int nums1[] = {-1, 2, 1, 4};
	int target1 = 2;

	printf("result 1: %d\n", threeSumClosest(nums1, ARRAY_SIZE(nums1), target1));
	int nums2[] = {1, 1, 1, 0};
	int target2 = -100;

	printf("result 2: %d\n", threeSumClosest(nums2, ARRAY_SIZE(nums2), target2));

	int nums3[] = {-43,57,-71,47,3,30,-85,6,60,-59,0,-46,-40,-73,53,68,-82,-54,88,73,20,-89,-22,39,55,-26,95,-87,-57,-86,28,-37,43,-27,-24,-88,-35,82,-3,39,-85,-46,37,45,-24,35,-49,-27,-96,89,87,-62,85,-44,64,78,14,59,-55,-10,0,98,50,-75,11,97,-72,85,-68,-76,44,-12,76,76,8,-75,-64,-57,29,-24,27,-3,-45,-87,48,10,-13,17,94,-85,11,-42,-98,89,97,-66,66,88,-89,90,-68,-62,-21,2,37,-15,-13,-24,-23,3,-58,-9,-71,0,37,-28,22,52,-34,24,-8,-20,29,-98,55,4,36,-3,-9,98,-26,17,82,23,56,54,53,51,-50,0,-15,-50,84,-90,90,72,-46,-96,-56,-76,-32,-8,-69,-32,-41,-56,69,-40,-25,-44,49,-62,36,-55,41,36,-60,90,37,13,87,66,-40,40,-35,-11,31,-45,-62,92,96,8,-4,-50,87,-17,-64,95,-89,68,-51,-40,-85,15,50,-15,0,-67,-55,45,11,-80,-45,-10,-8,90,-23,-41,80,19,29,7};
	int target3 = 255;

	printf("result 3: %d\n", threeSumClosest(nums3, ARRAY_SIZE(nums3), target3));

	int nums4[] = {4,0,5,-5,3,3,0,-4,-5};
	int target4 = -2;

	printf("result 4: %d\n", threeSumClosest(nums4, ARRAY_SIZE(nums4), target4));

	int nums5[] = {112,311,268,-457,-384,313,764,818,890,724,569,681,422,-102,-855,-490,272,667,-999,496,487,-901,538,-48,662,866,-47,907,-409,-194,449,137,859,288,-325,465,221,-478,-483,25,-281,-260,946,-856,-390,325,-184,906,-489,703,-237,-305,709,17,47,-296,-989,-272,813,-211,-846,485,-587,-85,-304,804,222,733,-183,-275,130,59,-924,-570,-82,-63,-807,-741,541,250,-282,-106,-168,26,544,-660,-24,-463,-861,-359,-392,-75,-57,-601,928,-956,-197,870,65,-947,430,531,-12,354,380,182,822,264,-709,-575,-611,549,-739,358,-283,468,839,507,-673,831,-928,466,-571,963,-718,-729,539,-21,303,-17,-293,-245,-607,526,692,425,-349,-500,-867,-258,-159,599,6,521,-788,-830,911,-252,932,-546,-859,-153,162,362,-993,111,-772,614,-219,-318,-350,-637,-60,-436,122,-387,369,-261,-656,-442,768,735,-665,-835,-415,994,404,399,-674,931,499,478,-459,79,-994,108,-427,-992,352,638,-667,581,-526,843,-401,-820,144,164,-672,-514,-769,644,-466,589,157,746,115,-624,10,127,545,-288,-688,363,30,605,139,-244,33,676,-234,-165,-810,-696,657,-750,-968,-905,-842,-366,-618,585,-691,572,-663,-380,519,-934,-279,-582,344,-681,-312,-42,64,96,83,-15,-828,-585,-884,743,22,-971,138,265,-639,680,-779,36,-498,-417,-658,140,-595,-477,678,-134,-284,778,677,889,-39,-433,-829,-909,-103,-780,-930,-11,697,-874,-979,-669,-744,395,825,-949,-904,-81,738,563,-77,-952,432,732,-297,-378,298,633,-285,766,-89,445,719,196,48,-911,-877,480,450,-429,-375,15,102,211,726,-126,-797,-198,-379,824,-114,922,-560,-815,711,774,479,-353,802,55,308,473,891,8,396,-622,-821,3,437,29,-453,-400,71,-16,170,639,687,970,-908,-973,282,947,-755,-632,345,913,557,490,861,-495,-10,-250,148,275,920,-734,-161,-751,-887,-97,40,836,-218,699,-334,475,924,323,-599,776,-790,829,-307,-86,559,183,45,551,476,-230,-831,754,984,-550,-664,964,-355,-574,467,413,-551,-259,-777,484,-444,-300,-113,-893,-176,-834,-857,-753,128,-850,698,727,-188,-536,971,259,-441,-391,60,-752,371,231,28,418,145,603,-367,-74,-200,-460,-71,91,-68,-794,204,-614,-138,-121,876,-276,200,-889,-948,955,-273,509,470,696,92,309,810,-348,-456,-809,-291,900,-438,-878,-274,648,251,463,95,-584,-174,223,-580,286,218,-917,561,763,-596,-360,-953,921,-914,-202,-262,-795,-959,-67,-668,355,-612,-65,775,-482,-49,712,543,895,267,421,-960,174,-756,808,304,-761,941,-918,410,-418,-462,44,-819,-961,961,-706,-516,72,-903,532,-357,-299,-703,758,49,-647,398,11,886,656,105,885,-320,255,583,443,517,-337,571,-529,208,503,-27,-814,349,-879,109,-633,21,820,-471,-991,-458,206,-37,-315,989,793,276,-253,348,-185,-939,584,-717,-44,-45,-423,-704,-450,453,-43,-811,731,-127,185,280,723,417,156,319,552,-937,801,-339,522,666,-778,-131,201,-742,-823,-116,-569,747,-657,497,305,247,-124,444,646,126,533,2,714,-813,-405,591,4,-784,570,655,150,785,-920,-873,188,402,165,-515,-731,20,260,-266,420,742,-41,-678,-687,-698,821,224,375,332,179,625,834,-231,-671,-746,997,431,327,534,389,-80,968,210,-605,439,686,550,-730,582,704,960,627,-512,-617,540,-362,-344,-958,685,564,760,817,342,-104,-555,-996,881,-573,-171,-547,84,194,-675,-135,146,-871,-646,-537,-465,-368,-323,949,-533,787,176,973,58,-827,-101,873,753,812,982,740,-652,-711,-836,577,-724,-951,350,937,672,-988,-915,-606,492,-496,529,967,-876,-177,-785,434,-233,-590,-522,-648,-205,-710,-799,-294,240,-926,229,-7,-278,-72,745,-352,772,159,-561,504,744,-520,-701,-53,415,263,-109,-395,940,330,-972,-175,-396,74,794,-765,512,1000,-343,-1000,-486,-662,-707,-481,-150,483,-239,80,751,935,909,202,-416,-226,-801,-287,562,-33,-594,-140,-223,-720,694,-725,212,-806,-684,297,938,-881,27,-232,959,-469,-715,-145,620,-583,-702,454,-974,-302,-891,-508,35,-969,-852,-559,-518,616,-34,-965,314,710,-566,-609,786,-386,361,192,514,498,-154,-532,-727,246,448,-805,600,455,872,-66,-910,-310,894,-264,296,-70,535};
	int target5 = -8834;

	printf("result 5: %d\n", threeSumClosest(nums5, ARRAY_SIZE(nums5), target5));

	int nums6[] = {228,306,-217,-71,770,-128,60,277,230,-383,-161,88,841,373,493,-833,898,701,-252,884,-915,-809,-743,724,324,-179,-375,497,-844,674,601,-229,-612,372,-64,-781,-87,951,741,-577,803,700,500,-866,-97,-559,697,-566,-51,38,166,-430,317,825,962,320,-705,-834,-277,-676,45,985,40,441,801,214,-583,474,-431,-700,745,836,-444,-296,400,369,206,636,42,-463,14,-156,-739,-943,662,-70,-126,957,793,602,-65,169,-978,-608,448,845,-696,-20,445,257,552,-800,140,-379,621,935,-801,-232,524,48,-761,-826,-827,-518,-841,-358,-508,-531,447,208,-511,-385,-451,575,-121,344,56,-225,-41,154,812,-640,192,95,-99,287,-878,330,449,36,-814,-522,-813,970,588,574,541,-581,131,273,-440,668,-856,-488,508,-891,-627,689,-868,-108,274,796,-181,-709,165,-455,327,710,-153,-895,922,416,-62,-748,910,877,997,-685,499,-873,115,-266,312,-312,-249,-586,-546,654,-904,528,25,-728,133,978,-392,-609,-172,376,249,529,-937,-388,15,89,-513,807,-946,886,82,735,761,729,959,13,632,-256,-344,831,-343,483,-556,-354,325,217,-76,-691,-319,696,-506,269,-485,-294,965,-775,501,-807,76,179,-538,643,-287,-958,681,940,-784,768,-36,535,-22,790,232,238,79,576,-452,-400,607,68,897,-850,-698,83,-733,579,486,-495,869,-493,495,-113,-177,-118,-681,-248,963,480,-823,-913,-510,386,699,-462,655,227,-766,252,-621,815,-334,-597,-330,-962,-23,446,800,-567,-314,-877,-163,640,433,-133,-264,-626,-973,290,924,-105,-885,-629,-136,-107,644,543,-883,-774,-145,-899,7,71,954,-929,648,932,-116,364,-253,426,818,-438,794,934,-778,-235,851,811,155,-257,-953,-928,998,615,350,926,92,769,-727,345,109,-684,-336,346,417,0,-63,973,-604,-56,200,20,510,161,685,-2,218,-776,917,308,-544,357,-724,519,-18,16,-433,-832,590,-272,93,694,-863,-554,-865,278,181,829,-475,172,-934,-189,739,240,980,-373,-892,-515,-491,-712,-159,225,-639,665,-351,949,-704,933,-57,65,742,-387,-884,340,-964,-686,-80,174,390,91,880,537,113,-407,-912,-94,788,-648,580,631,314,-199,432,-465,852,104,-932,-384,-91,-428,708,450,-646,421,805,-718,-365,260,-135,-979,971,-726,743,868,928,434,725,191,-643,792,874,331,332,703,-137,-349,3,-50,-951,559,-467,764,122,-47,-472,-647,-535,758,144,929,-352,-526,53,589,675,-215,-505,-751,-871,-947,-703,-34,150,-1000,-476,-193,-441,319,243,-688,-516,63,-168,375,195,-501,167,861,-504,-234,349,586,901,722,671,-821,-83,-127,454,494,-984,-398,946,629,-520,-353,718,148,969,-39,-763,146,715,751,359,-282,-864,894,313,-674,-157,171,827,866,-764,-171,479,-320,778,628,-447,-507,-638,-716,-3,-547,-332,-8,714,378,-738,705,335,626,-404,-289,-957,17,566,177,-54,-860,173,-982,-140,616,863,43,134,842,-812,-817,864,496,462,415,389,-158,-777,717,-887,-92,209,-988,-29,410,-975,-303,-561,64,347,748,713,-25,-889,904,-794,577,-666,-300,862,-449,-242,-362,-907,-618,723,283,112,-424,272,487,-598,719,299,-689,-908,856,-316,-243,279,-767,-558,156,944,18,-106,-714,360,342,670,905,370,994,-869,780,887,-283,-75,765,266,-468,35,-251,385,211,504,947,49,244,86,534,542,-999,-1,-411,-269,51,268,-81,-996,-98,-762,-149,979,-308,-990,-304,406,-808,-203,391,21,-896,328,489,420,213,733,545,-478,117,-768,210,-134,10,597,-672,224,285,-230,-155,-560,298,516,753,-687,-881,-187,407,-377,-971,720,571,747,-593,334,-741,-569,-634,967,539,-550,419,-454,-514,429,-750,687,736,-486,94,-965,-997,-616,-32,212,937,-960,832,883,-412,-614,-24,799,187,-579,596,564,521,66,-148,-548,-209,185,-798,247,-938,658,-576,673,-747,-785,57,706,-786,39,-539,-858,-35,-717,-805,584,142,-936,197,907,-49,820,-854,354,-389,205,762,952,-43,105,73,502,-842,54,-152,-870,-720,814,-280,808,507,490,-231,-948,-673,610,903,515,311,756,377,-980,-174,-654,773,-631,-90,-357,728,292,223,-201,-752,757,966,233,824,338,264,996,5,-12,248,513,953,-995,-167,821,-408,50,-680,915,-662,591,-216,-131,-900,611,22,-497,98,-802,-825,-196,-16,59,467,603,-939,639,-499,37,451,-744,-429,-233,-442,704,-998,547,-422,159,882,1000,553,-525,304,-653,-170,288,678,-448,-521,460,810,-255,459,-123,-810,463,565,-737,-555,289,199,392,860,-89,-124,296,-40,-78,-950,-390,902,184,-397,895,-578,514,-903,-532,444,-512,374,931,511,286,-587,637,614,634,41,606,-420,-461,28,-779,-607,690,481,653,-58,-443,-859,-879,190,-905,-848,-394,-790,925,-855,-402,968,-265,813,-773,-839,81,182};
	int target6 = 3647;

	printf("result 6: %d\n", threeSumClosest(nums6, ARRAY_SIZE(nums6), target6));

	int nums7[] = {-1, 2, 1, -4};
	int target7 = 1;

	printf("result 7: %d\n", threeSumClosest(nums7, ARRAY_SIZE(nums7), target7));

	int nums8[] = {1, 1, 1, 0};
	int target8 = 100;

	printf("result 8: %d\n", threeSumClosest(nums8, ARRAY_SIZE(nums8), target8));

	int nums9[] = {1, 1, 1, 1};
	int target9 = 4;

	printf("result 9: %d\n", threeSumClosest(nums9, ARRAY_SIZE(nums9), target9));

	exit(0);
}
